# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

ACA-Py Training School is a Docker-based practice environment for learning ACA-Py (Aries Cloud Agent Python) multitenancy and agent-controller relationships. It demonstrates connection-less credential issuance and proof presentation flows using the BCovrin testnet.

## Commands

### Initial Setup
```bash
cp env.template .env
# Edit .env: set ISSUER_PUBLIC_DID_SEED (32-char seed registered at https://test.bcovrin.vonx.io)
# and SCHEMA_VERSION (unused version string like '1.0.0')
docker compose build
docker compose up -d
docker compose exec setup python3 setup.py  # Initialize tenants, DID, schema, cred defs
docker compose down && docker compose up -d  # Restart to load new .env values
```

### Restart Services
```bash
docker compose down && docker compose up -d  # Source code is mounted as volume, no rebuild needed
```

### View Logs
```bash
docker compose logs -f acapy
docker compose logs -f holder
docker compose logs -f issuer
docker compose logs -f verifier
```

### Test Credential Flow
```bash
curl http://localhost:8002/issue-credential/transcript  # Issue credential to holder
curl http://localhost:8002/present-proof/transcript     # Present proof to verifier
```

## Architecture

### Service Topology
- **acapy** (ports 8000/8001): Single ACA-Py instance running in multitenant mode with Askar wallet and PostgreSQL storage
- **holder** (port 8002): Flask app that acts as a credential holder
- **issuer** (port 8003): Flask app that issues credentials
- **verifier** (port 8004): Flask app that requests/verifies proofs
- **postgres**: Wallet storage backend
- **tails**: Tails file server for revocation
- **indy-vdr-proxy**: Caching proxy for ledger reads
- **setup**: Utility container for running setup.py

### Multitenancy Model
All three controllers (holder, issuer, verifier) are tenants of the single ACA-Py instance. Each tenant has a JWT token stored in `.env` (generated by setup.py) and communicates with ACA-Py via its Admin API using Bearer auth.

### Controller Pattern
Controllers in `controller/src/` are thin Flask wrappers around ACA-Py Admin API calls. They:
1. Receive webhook events at `/webhook/topic/<topic>/`
2. Expose simplified REST endpoints that orchestrate ACA-Py operations
3. Use environment variables for config: `ACAPY_ADMIN_URL`, `ACAPY_WALLET_TOKEN`, `CRED_DEF_ID_1`

### setup.py Flow
The setup script (`setup.py` in repo root, executed from setup container):
1. Creates three tenant wallets (holder, verifier, issuer)
2. Creates issuer DID from seed, assigns as public DID
3. Creates "transcript" schema with attributes: name, score, date, birthdate_dateint, timestamp
4. Creates credential definitions (revocable and non-revocable)
5. Writes all tokens and IDs back to `.env` file

### Connection-less Flows
Both credential issuance and proof presentation use out-of-band (OOB) invitations with attached messages, avoiding persistent connections between agents.
