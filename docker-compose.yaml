volumes:
  postgres-data:
  acapy-storage:
  tails-files:

services:
  postgres:
    image: postgres:14
    platform: linux/amd64
    environment:
      - PGUSER=postgres
      - POSTGRES_PASSWORD=mysecretpassword
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: pg_isready -U postgres
      interval: 5s
      timeout: 5s
      retries: 5
  tails:
    build:
      context: ./tails
    platform: linux/amd64
    ports:
      - 8080:8080
    volumes:
      - tails-files:/var/lib/tails-server
    entrypoint: [
      "tails-server", "--host", "0.0.0.0", "--port", "8080", "--storage-path", "/var/lib/tails-server"
    ]
  acapy:
    build:
      context: ./acapy
    platform: linux/amd64
    ports:
      - 8000:8000
      - 8001:8001
    volumes:
      - acapy-storage:/home/indy/.indy_client
    entrypoint: [ 
      "aca-py", "start", 
      "--admin", "0.0.0.0", "8001",
      "--endpoint", "http://acapy:8000",
      "--inbound-transport", "http", "0.0.0.0", "8000",
      "--outbound-transport", "http",
      "--tails-server-base-url", "http://tails:8080",
      "--tails-server-upload-url", "http://tails:8080",
      "--auto-accept-requests",
      "--auto-respond-credential-offer",
      "--auto-respond-credential-request",
      "--auto-store-credential",
      "--auto-respond-presentation-request",
      "--auto-verify-presentation",
      "--emit-new-didcomm-prefix",
      "--preserve-exchange-records",
    ]
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
        test: ["CMD", "curl", "-f", "http://acapy:8001/status/ready"]
        interval: 1m
        timeout: 10s
        retries: 3
        start_period: 10s
    environment:
      RUST_LOG: "debug"
      ACAPY_LOG_LEVEL: "debug"
      
      ACAPY_MULTITENANT: "true"
      ACAPY_MULTITENANT_ADMIN: "true"
      ACAPY_MULTITENANT_JWT_SECRET: "EKLKNBj4JasyVTuEWdyYjFis8ELBquuEErSHSB4DNWm2"
      ACAPY_MULTITENANCY_CONFIGURATION: |+
          {
            "wallet_type":"basic",
            "wallet_name":"tenancy_wallets",
            "cache_size":"100",
            "key_derivation_method":"RAW"
          }
          
      ACAPY_WALLET_ALLOW_INSECURE_SEED: "true"
      ACAPY_WALLET_TYPE: "askar"
      ACAPY_WALLET_NAME: "base_wallet"
      ACAPY_WALLET_KEY: "AgRVxFCXpuDS8NhYxamb8BkMDZr8NZzX9Y2Ut3ek6pRo"
      ACAPY_WALLET_KEY_DERIVATION_METHOD: "RAW"
      ACAPY_WALLET_STORAGE_TYPE: "postgres_storage"
      ACAPY_WALLET_STORAGE_CONFIG: |+
          {
            "url":"postgres:5432",
            "max_connections":"5",
            "min_idle_count":"0",
            "connection_timeout":"5",
            "wallet_scheme":"MultiWalletSingleTable"
          }
      ACAPY_WALLET_STORAGE_CREDS: |+
        {
          "account":"postgres",
          "password":"mysecretpassword",
          "admin_account":"postgres",
          "admin_password":"mysecretpassword"
        }

      ACAPY_ADMIN_INSECURE_MODE: "true"
      ACAPY_IMAGE_URL: "https://robohash.org/acapy"
      ACAPY_ADMIN_CLIENT_MAX_REQUEST_SIZE: "16"
      ACAPY_MAX_MESSAGE_SIZE: "16777216"
      ACAPY_MAX_OUTBOUND_RETRY: 1
      ACAPY_AUTO_PROVISION: "true"
      ACAPY_GENESIS_TRANSACTIONS: |+
        {"reqSignature":{},"txn":{"data":{"data":{"alias":"Node1","blskey":"4N8aUNHSgjQVgkpm8nhNEfDf6txHznoYREg9kirmJrkivgL4oSEimFF6nsQ6M41QvhM2Z33nves5vfSn9n1UwNFJBYtWVnHYMATn76vLuL3zU88KyeAYcHfsih3He6UHcXDxcaecHVz6jhCYz1P2UZn2bDVruL5wXpehgBfBaLKm3Ba","blskey_pop":"RahHYiCvoNCtPTrVtP7nMC5eTYrsUA8WjXbdhNc8debh1agE9bGiJxWBXYNFbnJXoXhWFMvyqhqhRoq737YQemH5ik9oL7R4NTTCz2LEZhkgLJzB3QRQqJyBNyv7acbdHrAT8nQ9UkLbaVL9NBpnWXBTw4LEMePaSHEw66RzPNdAX1","client_ip":"138.197.138.255","client_port":9702,"node_ip":"138.197.138.255","node_port":9701,"services":["VALIDATOR"]},"dest":"Gw6pDLhcBcoQesN72qfotTgFa7cbuqZpkX3Xo6pLhPhv"},"metadata":{"from":"Th7MpTaRZVRYnPiabds81Y"},"type":"0"},"txnMetadata":{"seqNo":1,"txnId":"fea82e10e894419fe2bea7d96296a6d46f50f93f9eeda954ec461b2ed2950b62"},"ver":"1"}
        {"reqSignature":{},"txn":{"data":{"data":{"alias":"Node2","blskey":"37rAPpXVoxzKhz7d9gkUe52XuXryuLXoM6P6LbWDB7LSbG62Lsb33sfG7zqS8TK1MXwuCHj1FKNzVpsnafmqLG1vXN88rt38mNFs9TENzm4QHdBzsvCuoBnPH7rpYYDo9DZNJePaDvRvqJKByCabubJz3XXKbEeshzpz4Ma5QYpJqjk","blskey_pop":"Qr658mWZ2YC8JXGXwMDQTzuZCWF7NK9EwxphGmcBvCh6ybUuLxbG65nsX4JvD4SPNtkJ2w9ug1yLTj6fgmuDg41TgECXjLCij3RMsV8CwewBVgVN67wsA45DFWvqvLtu4rjNnE9JbdFTc1Z4WCPA3Xan44K1HoHAq9EVeaRYs8zoF5","client_ip":"138.197.138.255","client_port":9704,"node_ip":"138.197.138.255","node_port":9703,"services":["VALIDATOR"]},"dest":"8ECVSk179mjsjKRLWiQtssMLgp6EPhWXtaYyStWPSGAb"},"metadata":{"from":"EbP4aYNeTHL6q385GuVpRV"},"type":"0"},"txnMetadata":{"seqNo":2,"txnId":"1ac8aece2a18ced660fef8694b61aac3af08ba875ce3026a160acbc3a3af35fc"},"ver":"1"}
        {"reqSignature":{},"txn":{"data":{"data":{"alias":"Node3","blskey":"3WFpdbg7C5cnLYZwFZevJqhubkFALBfCBBok15GdrKMUhUjGsk3jV6QKj6MZgEubF7oqCafxNdkm7eswgA4sdKTRc82tLGzZBd6vNqU8dupzup6uYUf32KTHTPQbuUM8Yk4QFXjEf2Usu2TJcNkdgpyeUSX42u5LqdDDpNSWUK5deC5","blskey_pop":"QwDeb2CkNSx6r8QC8vGQK3GRv7Yndn84TGNijX8YXHPiagXajyfTjoR87rXUu4G4QLk2cF8NNyqWiYMus1623dELWwx57rLCFqGh7N4ZRbGDRP4fnVcaKg1BcUxQ866Ven4gw8y4N56S5HzxXNBZtLYmhGHvDtk6PFkFwCvxYrNYjh","client_ip":"138.197.138.255","client_port":9706,"node_ip":"138.197.138.255","node_port":9705,"services":["VALIDATOR"]},"dest":"DKVxG2fXXTU8yT5N7hGEbXB3dfdAnYv1JczDUHpmDxya"},"metadata":{"from":"4cU41vWW82ArfxJxHkzXPG"},"type":"0"},"txnMetadata":{"seqNo":3,"txnId":"7e9f355dffa78ed24668f0e0e369fd8c224076571c51e2ea8be5f26479edebe4"},"ver":"1"}
        {"reqSignature":{},"txn":{"data":{"data":{"alias":"Node4","blskey":"2zN3bHM1m4rLz54MJHYSwvqzPchYp8jkHswveCLAEJVcX6Mm1wHQD1SkPYMzUDTZvWvhuE6VNAkK3KxVeEmsanSmvjVkReDeBEMxeDaayjcZjFGPydyey1qxBHmTvAnBKoPydvuTAqx5f7YNNRAdeLmUi99gERUU7TD8KfAa6MpQ9bw","blskey_pop":"RPLagxaR5xdimFzwmzYnz4ZhWtYQEj8iR5ZU53T2gitPCyCHQneUn2Huc4oeLd2B2HzkGnjAff4hWTJT6C7qHYB1Mv2wU5iHHGFWkhnTX9WsEAbunJCV2qcaXScKj4tTfvdDKfLiVuU2av6hbsMztirRze7LvYBkRHV3tGwyCptsrP","client_ip":"138.197.138.255","client_port":9708,"node_ip":"138.197.138.255","node_port":9707,"services":["VALIDATOR"]},"dest":"4PS3EDQ3dW1tci1Bp6543CfuuebjFrg36kLAUcskGfaA"},"metadata":{"from":"TWwCRQRZ2ZHMJFn9TzLp7W"},"type":"0"},"txnMetadata":{"seqNo":4,"txnId":"aa5e817d7cc626170eca175822029339a444eb0ee8f0bd20d3b0b76e566fb008"},"ver":"1"}
        {"reqSignature":{"type":"ED25519","values":[{"from":"QacK4UiSTf1aaK48TxuEGR","value":"4DmDvSN6GactxZBNs1TmoLvFST4aKUir83DxBnwvM9aoZS8NkouhmZjck2yNGgNUYkNkLQdf2NFthCC3shLiEk7b"}]},"txn":{"data":{"data":{"alias":"BCovrin01","blskey":"4B2YFAa8MDiGuh7CvjD5nuApqXMGvgYbdbZq3D8pQywTaLZmuMKcNu9KHZM7E64ZypBfKfgfPzADdQaLhhh5NA1ycuoG84pQz1Q1RjaRNf9HP5YH9NFjSnS1ssVNjLyX2courwdVfYbNZ2MTNY8nAuiD3g1Jn3MJcvchAK1xGeeqkuy","blskey_pop":"QrCvZzZJoGMsDM16XMryE2p2vvfr3ah3ZXj2PQe5DBKpdcnc6Lcb6m8TTRtJLvFbFWhcbUXVZVeESEWFu4hmawimcrytUUvwukP2m1chAL35rF7Yw9htnNVf6yRPcuJvyFucYKLvESSueCzt1gb7E6dersqij18yqoeHEismXZct3h","client_ip":"130.107.207.129","client_port":9702,"node_ip":"130.107.207.129","node_port":9701,"services":["VALIDATOR"]},"dest":"HKG8kcARyViNsZhXZiUpPZKXfQEWAyd34LusbqGTBmNe"},"metadata":{"digest":"d632c4f256783cfa41373036494d6d5a8da186143a3ecfbdbbfdf0f23fe91a05","from":"QacK4UiSTf1aaK48TxuEGR","payloadDigest":"d4f4f9fef10d3b71b5d231a9d1443bda4d575fe349daccbdbbdb0819bbc457a9","reqId":1757965190326432796},"protocolVersion":2,"type":"0"},"txnMetadata":{"seqNo":5,"txnTime":1757965188},"ver":"1"}
        {"reqSignature":{"type":"ED25519","values":[{"from":"QacK4UiSTf1aaK48TxuEGR","value":"3ZStF5Rjh9JyYnSCD6BZftMtY2Cp8xnptj2fJfXUAh9xARm7tGVy7nbDvsgaYSkZ3Xi6eNMuJwLptVqCv5pdpA2N"}]},"txn":{"data":{"data":{"alias":"BCovrin01","services":[]},"dest":"HKG8kcARyViNsZhXZiUpPZKXfQEWAyd34LusbqGTBmNe"},"metadata":{"digest":"a63fde55671b0b38a39109cedf5f4a20f33e62840bdc895947c0bb254ec9724f","from":"QacK4UiSTf1aaK48TxuEGR","payloadDigest":"6912fdf0278d1e81e7f1eb51c7c1f22876846638172a960c28b3a70eb0131cb0","reqId":1757965418732675268},"protocolVersion":2,"type":"0"},"txnMetadata":{"seqNo":6,"txnTime":1757965417},"ver":"1"}
        {"reqSignature":{"type":"ED25519","values":[{"from":"QacK4UiSTf1aaK48TxuEGR","value":"66f2YgxoCTcGhCxejwpXbjxLf4HDa4uKDp2uETLADzmW1Zy6P8X6rnmJm3bSDCwkuDQ1MBsabhK3SJoEE2C2UQJC"}]},"txn":{"data":{"data":{"alias":"BCovrin01","services":["VALIDATOR"]},"dest":"HKG8kcARyViNsZhXZiUpPZKXfQEWAyd34LusbqGTBmNe"},"metadata":{"digest":"87078cbf94319c6bfeadcf5658533508622835a9169a2ed0578e820e93083f5d","from":"QacK4UiSTf1aaK48TxuEGR","payloadDigest":"d51b5f912ad397560669973e31b80ed1950fbc37343b962a6f64e51997228021","reqId":1757966728426907714},"protocolVersion":2,"type":"0"},"txnMetadata":{"seqNo":7,"txnTime":1757966727},"ver":"1"}
        {"reqSignature":{"type":"ED25519","values":[{"from":"GP6VVbdWPjKcL8ahbbxS21","value":"3iBuKUYwMXgLywU1o2aWUcqTzJupLMfe91Y3gEnkWA9WtUxsXBfX2MtPqPuF7cRxGnCEtWQAXAwESvZeJjYxZbib"}]},"txn":{"data":{"data":{"alias":"BCovrin02","blskey":"2Lwv1yGbK9pfouhSgMBU5gM4pkKckRpm2banfsm2Erk8tAXR2HJYmYmysm7sKWPQw7nF3qzFxMuvx3B2uWFyxqk23Qhdc9iZKKKmE4CxND9GqzBoDNVz8yC6CyiTTkqvC2cGvGcf7fWRBicZoMzLwfsUuYYuo9sUnG2eh6JfUpRS597","blskey_pop":"RRYeUCfFAcgzBZoCdkjq77VGaJdS2uuKite92mE4RKxspkJbvNpGUoQt8Yk6SVN6LK8pEnTZggPByYUzwKv3uE9etbzAYBKuQ5MadAL3wTdUfpZisHqUqpuPoroR1YsTNPwNFyzdenL3WwAqcs95ZHuNf8XuFyaxdWiNLhHzcsYvwy","client_ip":"130.107.207.129","client_port":9704,"node_ip":"130.107.207.129","node_port":9703,"services":["VALIDATOR"]},"dest":"E3gWL16C74AGtdNABGNtPrS8xAfgNVdZHeD1B9gQNojQ"},"metadata":{"digest":"b6e53f5fda5804b23b0e58b592ea031d5f490d54cf89a92d159af1de9f61bb56","from":"GP6VVbdWPjKcL8ahbbxS21","payloadDigest":"9a75b39db6b1b06f520d931ed02521e26a5350bb834780dcd5a1b61ba1f644e0","reqId":1758027129447701708},"protocolVersion":2,"type":"0"},"txnMetadata":{"seqNo":8,"txnTime":1758027129},"ver":"1"}
        {"reqSignature":{"type":"ED25519","values":[{"from":"B3d91BzBvxeJY29S53kvZS","value":"3Vd7GHXrr7B1Nox4AGLVUWk9eJUUzzcfk6sh8AimNJ8PQEGbbNyoZ8ieK8hVJworutg15PALLgxmUz7oyhpQ5P7Y"}]},"txn":{"data":{"data":{"alias":"BCovrin03","blskey":"15q94XEnswiaCbJWLNFfw1sX4LNeivqRK4z4wHDnEVscCjYs1aJFPZyWmsU7DzNo31ZzqHrxGkYvZBiMAWR5WEB98ipQodVWrYy7GNibhCTs9F18HhYNzKgQWYcvXknYCL7e6KzrNU4qbodNCdy3k1pmWdSQHetsiR6ZbqnVZdrJKFt","blskey_pop":"QySdiYeES9Qy3BacCS5kFqGF2Gfc25mXni7a4rnrfXFmLFh73BKVhaLPL4Nr4cuCkMPYkN6HziTGS15fs9hzE4s4YZYuiHp83GnSWdmxnBiFGEUSUUwJDUXMhHUwxcNsCuTmrBbJoxcv2D8eecqoqD4QCRiiBGtbVpFVeJzBtm787R","client_ip":"130.107.207.129","client_port":9706,"node_ip":"130.107.207.129","node_port":9705,"services":["VALIDATOR"]},"dest":"3bH3KWZ2q8TFQ8Bdyj9skAvWet99CDWjYVqJS4yUbBxn"},"metadata":{"digest":"1a4e33e56fb93498cd6d3d63c8302b419990bd624c79b7f3bcd1c4b477bd4222","from":"B3d91BzBvxeJY29S53kvZS","payloadDigest":"ec58f2474e1f2cab5037e043df2c0200868476e058ef46813264b6fc2464c304","reqId":1758028609248616672},"protocolVersion":2,"type":"0"},"txnMetadata":{"seqNo":9,"txnTime":1758028609},"ver":"1"}
        {"reqSignature":{"type":"ED25519","values":[{"from":"LukV4612A9ro4JhTM6o4GJ","value":"5VHd6H2wbrVjcWUrSnvnZU25BZAP2T65dkemDkcQis9iz2yS2ez7mwQGcLook1UarAHp6mcmYgwZw58ixArhonxq"}]},"txn":{"data":{"data":{"alias":"BCovrin04","blskey":"2GQf9xmHsraSZqgDi44dgit98Jf2yzKY9Ky5McPUswUVwjnUyssfUbUxJJrhbYNNEeAcaThL3tRpGFWbCjQwRDSyBQ6BNRG7D7Xvvq3HhvNbeY4uFGURq5u1mua3vFEugMJVpRLTuFCaaFq7a1TEFS6BenBzV6SnqUcMsRZBrXUnyHh","blskey_pop":"R33FtSQnjQK5KsZqDbmJ9VcqzwYyJYtv68hQ1q5JEsy8G1LV1Y4VCeUjbVqHvQyqrZ4gzyVNLMZq1pxksN7hfSJ6vRJoFK9KKk4Tq1w4ChXEkTrDo7NbnZBvxz1cPDk2xPsj6tMvse7wNNADWTkc3isB4TyGmQx4gsfM7BaYMvmv87","client_ip":"130.107.207.129","client_port":9708,"node_ip":"130.107.207.129","node_port":9707,"services":["VALIDATOR"]},"dest":"7zGQEHtRvdTEBMftor2EEMqUjsyq4TTq35EwkZvwFQ7G"},"metadata":{"digest":"56481aaaadef7e18e7dbdcf946cecff8c5ffe4a36c73eda053f687c484ddc039","from":"LukV4612A9ro4JhTM6o4GJ","payloadDigest":"c991ff00d185f0e969e4f05e5180313c2f9ca5fca429b91731a4308d0ed12c7f","reqId":1758029835980946655},"protocolVersion":2,"type":"0"},"txnMetadata":{"seqNo":10,"txnTime":1758029836},"ver":"1"}

  holder-controller:
    build:
      context: ./controller
    platform: linux/amd64
    ports:
      - 8002:80
    volumes:
      - ./controller/src:/app/src
    entrypoint: [
       "python3", "src/holder.py"
    ]
    environment:
      ACAPY_WALLET_TOKEN: "${HOLDER_WALLET_TOKEN}"
      ACAPY_ADMIN_URL: "http://acapy:8001"
      ISSUER_ENDPOINT: "http://issuer-controller:80"
      VERIFIER_ENDPOINT: "http://verifier-controller:80"
  issuer-controller:
    build:
      context: ./controller
    platform: linux/amd64
    ports:
      - 8003:80
    volumes:
      - ./controller/src:/app/src
    entrypoint: [
       "python3", "src/issuer.py"
    ]
    environment:
      ACAPY_WALLET_TOKEN: "${ISSUER_WALLET_TOKEN}"
      ACAPY_ADMIN_URL: "http://acapy:8001"
      CRED_DEF_ID_1: "${CRED_DEF_ID_1}"
  verifier-controller:
    build:
      context: ./controller
    platform: linux/amd64
    ports:
      - 8004:80
    volumes:
      - ./controller/src:/app/src
    entrypoint: [
       "python3", "src/verifier.py"
    ]
    environment:
      ACAPY_WALLET_TOKEN: "${VERIFIER_WALLET_TOKEN}"
      ACAPY_ADMIN_URL: "http://acapy:8001"
      CRED_DEF_ID_1: "${CRED_DEF_ID_1}"
  setup:
    build:
      context: ./setup
    platform: linux/amd64
    volumes:
      - ./:/setup/
    entrypoint: [
      "bash", "-c", "while true; do sleep 10000; done"
    ]
